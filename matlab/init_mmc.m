clear

J = [0 -1; 1 0];

%% problem parameters

sim.ts = 1e-6;
sim.fs = 1 / sim.ts;
sim.fs_unit = sim.fs / 2;

fpga.ts = 20e-6;
cpu.ts = 200e-6;

converter.s = 40e6;

grid.f = 50;
% grid.v = 220e3;
grid.v = 33e3;
grid.tr.l = 0.1;  % in p.u.
grid.tr.r = 0.01;  % in p.u.

machine.f = 16.7;
machine.f_gain = 1.02;
machine.v = 33e3;
machine.tr.l = 0.16;  % in p.u.
machine.tr.r = 0.01;  % in p.u.

mmc.l_leg_si = 5e-3;
mmc.r_leg_si = 10e-3;

mmc.cell.v_dc = 5e3;
mmc.cell.c_dc = 5e-3;
mmc.cell.n = 14;

% 0 - MMC cell
% 1 - averaged model
ctrl.cell.sel = 0;

ctrl.grid.pll.kp = 0.096;
ctrl.grid.pll.ti = 0.0849;
ctrl.grid.pll.init_w = 1;

ctrl.grid.ictrl.kp = 0.342;
ctrl.grid.ictrl.ti = 2e-3;

% 0 - vector current control
% 1 - safety filter
ctrl.machine.ictrl.sel = 1;

ctrl.vdcctrl.kp = 0.342*20;
ctrl.vdcctrl.ti = 0.1;

pq_ctrl.f_ref = 1.0;
pq_ctrl.vg_ref = 1.0;
pq_ctrl.fp_droop = -0.02;
pq_ctrl.uq_droop = 0.05;
pq_ctrl.kp = 0.45;
pq_ctrl.ti = 0.04*3;
pq_ctrl.enable = 0.4;

soa.i_lim = 1.18;
soa.m_max = 1.2;

% safety.f_data = [0.0,0.0,0.0,0.0,0.0,0.0,-1963.4954084936207,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,-1963.4954084936207;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0];
% safety.G_data = [1963.4954084936207;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1963.4954084936207;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1.0;0.0;0.0;0.0;0.0];
% safety.V_data = [-1.0000000000735716,1.6172782491485343e-11,6.1684978641187325e-12,1.465783100232845e-11,3.1398845467506884e-11,-1.7154040321468697e-11,-5.677536205654355e-12,-1.1711215712954013e-11,-3.3128705124128644e-11,3.6911538370693564,-2.395321826218312e-06,0.6863364765872854,-4.206956038864978,-3.367217480065877,-0.10350620769371388,-0.44466372745225524,4.412517579256277,-2.395321826218312e-06,3.691114527386194,4.206981628420729,0.6862989591835219,0.10351249234717226,-3.3671737803834563,-4.412541018733359,-0.4446268362878494,0.6863364765872854,4.206981628420729,17.857183665664824,-1.4887403348286464e-05,-0.3377324649962087,-4.766436813232083,-17.242207114418765,0.0003610044778513785,-4.206956038864978,0.6862989591835219,-1.4887403348286464e-05,17.857194919462223,4.766414258672558,-0.33769241267957417,-0.00031952780577086025,-17.242214448191536,-3.367217480065877,0.10351249234717226,-0.3377324649962087,4.766414258672558,3.739367688863163,-3.888426807956358e-06,0.08561238990207704,-4.988762644701483,-0.10350620769371388,-3.3671737803834563,-4.766436813232083,-0.33769241267957417,-3.888426807956358e-06,3.7393189537896654,4.988783346340025,0.08557297539367427,-0.44466372745225524,-4.412541018733359,-17.242207114418765,-0.00031952780577086025,0.08561238990207704,4.988783346340025,16.734743212464913,-2.670503349231045e-05,4.412517579256277,-0.4446268362878494,0.0003610044778513785,-17.242214448191536,-4.988762644701483,0.08557297539367427,-2.670503349231045e-05,16.734746859497367];
% safety.B_data = [-1.0,1.423747414726703e-12,0.0,0.0,0.0,-1.4165842069675917e-12,1.0519643367038407e-12,1.0757921995635227e-12,-1.7044893481791489e-12,0.6503642104128027,-8.670949584762517e-11,-7.723720271258358e-11,6.242827457465205e-10,-7.285363475151831e-09,9.208074897865483e-11,7.076635596149901e-10,4.905825661619718e-10,-8.670949584762517e-11,0.650364213439007,-4.472831707268404e-10,9.7334475851586e-10,1.0323170751318356e-10,-1.063619760470319e-08,-9.55202453597318e-10,8.089603765672348e-11,-7.723720271258358e-11,-4.472831707268404e-10,0.0025000039243545024,-4.225240748109259e-09,1.4760595581001493e-10,3.755358410377111e-10,-3.179745701831944e-09,3.1113704966469857e-09,6.242827457465205e-10,9.7334475851586e-10,-4.225240748109259e-09,0.0025000142568386867,-6.900327658327517e-10,-7.202733513742401e-10,3.560289774139028e-09,-1.0851128930353706e-08,-7.285363475151831e-09,1.0323170751318356e-10,1.4760595581001493e-10,-6.900327658327517e-10,7.966495258235521e-09,-1.11021775841474e-10,-8.733543489773861e-10,-5.551628366153528e-10,9.208074897865483e-11,-1.063619760470319e-08,3.755358410377111e-10,-7.202733513742401e-10,-1.11021775841474e-10,1.1684633079500157e-08,1.2433731280569026e-09,-4.1896965000266563e-10,7.076635596149901e-10,-9.55202453597318e-10,-3.179745701831944e-09,3.560289774139028e-09,-8.733543489773861e-10,1.2433731280569026e-09,7.09495956336665e-09,-2.648878869579398e-09,4.905825661619718e-10,8.089603765672348e-11,3.1113704966469857e-09,-1.0851128930353706e-08,-5.551628366153528e-10,-4.1896965000266563e-10,-2.648878869579398e-09,1.2765349840266652e-08];
% safety.nV_data = [1.6172782491485343e-11,7.382307674138713,-4.790643652436624e-06,1.3726729531745707,-8.413912077729956,-6.734434960131754,-0.20701241538742776,-0.8893274549045105,8.825035158512554;6.1684978641187325e-12,-4.790643652436624e-06,7.382229054772388,8.413963256841457,1.3725979183670438,0.20702498469434452,-6.7343475607669125,-8.825082037466718,-0.8892536725756988;1.465783100232845e-11,1.3726729531745707,8.413963256841457,35.71436733132965,-2.9774806696572928e-05,-0.6754649299924174,-9.532873626464166,-34.48441422883753,0.000722008955702757;3.1398845467506884e-11,-8.413912077729956,1.3725979183670438,-2.9774806696572928e-05,35.71438983892445,9.532828517345116,-0.6753848253591483,-0.0006390556115417205,-34.48442889638307;-1.7154040321468697e-11,-6.734434960131754,0.20702498469434452,-0.6754649299924174,9.532828517345116,7.478735377726326,-7.776853615912716e-06,0.17122477980415407,-9.977525289402966;-5.677536205654355e-12,-0.20701241538742776,-6.7343475607669125,-9.532873626464166,-0.6753848253591483,-7.776853615912716e-06,7.478637907579331,9.97756669268005,0.17114595078734854;-1.1711215712954013e-11,-0.8893274549045105,-8.825082037466718,-34.48441422883753,-0.0006390556115417205,0.17122477980415407,9.97756669268005,33.469486424929826,-5.34100669846209e-05;-3.3128705124128644e-11,8.825035158512554,-0.8892536725756988,0.000722008955702757,-34.48442889638307,-9.977525289402966,0.17114595078734854,-5.34100669846209e-05,33.469493718994734];
% safety.nB_data = [1.423747414726703e-12,1.3007284208256054,-1.7341899169525035e-10,-1.5447440542516715e-10,1.248565491493041e-09,-1.4570726950303661e-08,1.8416149795730966e-10,1.4153271192299802e-09,9.811651323239435e-10;0.0,-1.7341899169525035e-10,1.300728426878014,-8.945663414536808e-10,1.94668951703172e-09,2.0646341502636712e-10,-2.127239520940638e-08,-1.910404907194636e-09,1.6179207531344697e-10;0.0,-1.5447440542516715e-10,-8.945663414536808e-10,0.005000007848709005,-8.450481496218518e-09,2.9521191162002985e-10,7.510716820754222e-10,-6.359491403663888e-09,6.222740993293971e-09;0.0,1.248565491493041e-09,1.94668951703172e-09,-8.450481496218518e-09,0.005000028513677373,-1.3800655316655035e-09,-1.4405467027484802e-09,7.120579548278056e-09,-2.170225786070741e-08;-1.4165842069675917e-12,-1.4570726950303661e-08,2.0646341502636712e-10,2.9521191162002985e-10,-1.3800655316655035e-09,1.5932990516471042e-08,-2.22043551682948e-10,-1.7467086979547722e-09,-1.1103256732307056e-09;1.0519643367038407e-12,1.8416149795730966e-10,-2.127239520940638e-08,7.510716820754222e-10,-1.4405467027484802e-09,-2.22043551682948e-10,2.3369266159000314e-08,2.486746256113805e-09,-8.379393000053313e-10;1.0757921995635227e-12,1.4153271192299802e-09,-1.910404907194636e-09,-6.359491403663888e-09,7.120579548278056e-09,-1.7467086979547722e-09,2.486746256113805e-09,1.41899191267333e-08,-5.297757739158796e-09;-1.7044893481791489e-12,9.811651323239435e-10,1.6179207531344697e-10,6.222740993293971e-09,-2.170225786070741e-08,-1.1103256732307056e-09,-8.379393000053313e-10,-5.297757739158796e-09,2.5530699680533304e-08];
% safety.gamma_V_data = [350.4402998492871];
% safety.gamma_B_data = [2770.251466543892];

safety.f_data = [0.0,0.0,0.0,0.0,0.0,0.0,-1963.4954084936207,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,-1963.4954084936207;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0];
safety.G_data = [1963.4954084936207;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1963.4954084936207;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1.0;0.0;0.0;0.0;0.0];
safety.V_data = [-1.0000000000405045,-1.2634656214029108e-09,5.9154844941202845e-09,-6.321085531043989e-09,2.2227191226928817e-09,1.2583458433565668e-09,-6.482033049741308e-09,4.953235942171549e-09,-1.6717772990509357e-09,3.665966907909177,-0.0856154456386902,1.0297149848490639,-4.701001793746126,-3.3332624336627488,-0.016390379424706305,-0.836310696487837,4.929064216530326,-0.0856154456386902,3.5502286207513283,4.617835656685343,0.8371813112986085,0.20967253806908626,-3.198096688298643,-4.758683923628657,-0.675507498898684,1.0297149848490639,4.617835656685343,18.787367953863605,-0.15732565322543973,-0.6866257272328824,-5.209169858325007,-18.241412184378355,0.266243274296708,-4.701001793746126,0.8371813112986085,-0.15732565322543973,19.080600434415853,5.311473660624279,-0.49936425853122746,0.11897432035553891,-18.518568561469138,-3.3332624336627488,0.20967253806908626,-0.6866257272328824,5.311473660624279,3.695993897588298,-0.10891852880233324,0.48626298051195754,-5.556627811288338,-0.016390379424706305,-3.198096688298643,-5.209169858325007,-0.49936425853122746,-0.10891852880233324,3.5371476441182503,5.3589496946413755,0.3334495059729535,-0.836310696487837,-4.758683923628657,-18.241412184378355,0.11897432035553891,0.48626298051195754,5.3589496946413755,17.767188874104516,-0.215207712507332,4.929064216530326,-0.675507498898684,0.266243274296708,-18.518568561469138,-5.556627811288338,0.3334495059729535,-0.215207712507332,18.058339821166026];
safety.B_data = [-1.0,0.0,-2.008346568803066e-11,-4.120843486946159e-12,6.057993828752493e-12,3.4257070695597267e-12,-1.7705600962484076e-11,-5.7178795784611996e-12,4.423427306426973e-12,0.6503642119754487,-4.206679392724472e-12,4.2475482826192284e-10,8.00439439922434e-10,-8.929158005367511e-09,1.7117202031553016e-11,1.8533769631363384e-10,7.594131536773903e-10,-4.206679392724472e-12,0.650364212395314,-6.19685879948988e-10,4.6195110370346936e-10,-1.4028391362869253e-11,-9.340832118129165e-09,-5.919812288866475e-10,2.6069174160869884e-10,4.2475482826192284e-10,-6.19685879948988e-10,0.0025000108813724923,1.341927214752055e-11,-2.0823612007796553e-10,6.063239970314981e-10,-8.442712234207641e-09,-7.498869908515001e-11,8.00439439922434e-10,4.6195110370346936e-10,1.341927214752055e-11,0.0025000110234913737,-8.148924529030116e-10,-2.2243954930764116e-10,3.2744991049787433e-10,-8.473843207441576e-09,-8.929158005367511e-09,-1.4028391362869253e-11,-2.0823612007796553e-10,-8.148924529030116e-10,9.780680101508287e-09,0.0,-4.10596156507895e-10,-9.092980976996442e-10,1.7117202031553016e-11,-9.340832118129165e-09,6.063239970314981e-10,-2.2243954930764116e-10,0.0,1.0189985026197236e-08,7.253764935448899e-10,-4.239093496152682e-10,1.8533769631363384e-10,-5.919812288866475e-10,-8.442712234207641e-09,3.2744991049787433e-10,-4.10596156507895e-10,7.253764935448899e-10,9.826900631329896e-09,4.9927583261128133e-11,7.594131536773903e-10,2.6069174160869884e-10,-7.498869908515001e-11,-8.473843207441576e-09,-9.092980976996442e-10,-4.239093496152682e-10,4.9927583261128133e-11,9.712543482672883e-09];
safety.nV_data = [-1.2634656214029108e-09,7.331933815818354,-0.1712308912773804,2.0594299696981277,-9.402003587492253,-6.6665248673254975,-0.03278075884941261,-1.672621392975674,9.858128433060651;5.9154844941202845e-09,-0.1712308912773804,7.100457241502657,9.235671313370686,1.674362622597217,0.4193450761381725,-6.396193376597286,-9.517367847257313,-1.351014997797368;-6.321085531043989e-09,2.0594299696981277,9.235671313370686,37.57473590772721,-0.31465130645087946,-1.3732514544657648,-10.418339716650014,-36.48282436875671,0.532486548593416;2.2227191226928817e-09,-9.402003587492253,1.674362622597217,-0.31465130645087946,38.161200868831706,10.622947321248558,-0.9987285170624549,0.23794864071107782,-37.037137122938276;1.2583458433565668e-09,-6.6665248673254975,0.4193450761381725,-1.3732514544657648,10.622947321248558,7.391987795176596,-0.21783705760466648,0.9725259610239151,-11.113255622576675;-6.482033049741308e-09,-0.03278075884941261,-6.396193376597286,-10.418339716650014,-0.9987285170624549,-0.21783705760466648,7.074295288236501,10.717899389282751,0.666899011945907;4.953235942171549e-09,-1.672621392975674,-9.517367847257313,-36.48282436875671,0.23794864071107782,0.9725259610239151,10.717899389282751,35.53437774820903,-0.430415425014664;-1.6717772990509357e-09,9.858128433060651,-1.351014997797368,0.532486548593416,-37.037137122938276,-11.113255622576675,0.666899011945907,-0.430415425014664,36.11667964233205];
safety.nB_data = [0.0,1.3007284239508974,-8.413358785448945e-12,8.495096565238457e-10,1.600878879844868e-09,-1.7858316010735023e-08,3.423440406310603e-11,3.706753926272677e-10,1.5188263073547805e-09;-2.008346568803066e-11,-8.413358785448945e-12,1.300728424790628,-1.239371759897976e-09,9.239022074069387e-10,-2.8056782725738505e-11,-1.868166423625833e-08,-1.183962457773295e-09,5.213834832173977e-10;-4.120843486946159e-12,8.495096565238457e-10,-1.239371759897976e-09,0.005000021762744985,2.68385442950411e-11,-4.1647224015593105e-10,1.2126479940629963e-09,-1.6885424468415283e-08,-1.4997739817030001e-10;6.057993828752493e-12,1.600878879844868e-09,9.239022074069387e-10,2.68385442950411e-11,0.005000022046982747,-1.6297849058060232e-09,-4.4487909861528233e-10,6.548998209957487e-10,-1.6947686414883153e-08;3.4257070695597267e-12,-1.7858316010735023e-08,-2.8056782725738505e-11,-4.1647224015593105e-10,-1.6297849058060232e-09,1.9561360203016573e-08,0.0,-8.2119231301579e-10,-1.8185961953992884e-09;-1.7705600962484076e-11,3.423440406310603e-11,-1.868166423625833e-08,1.2126479940629963e-09,-4.4487909861528233e-10,0.0,2.0379970052394472e-08,1.4507529870897797e-09,-8.478186992305364e-10;-5.7178795784611996e-12,3.706753926272677e-10,-1.183962457773295e-09,-1.6885424468415283e-08,6.548998209957487e-10,-8.2119231301579e-10,1.4507529870897797e-09,1.9653801262659793e-08,9.985516652225627e-11;4.423427306426973e-12,1.5188263073547805e-09,5.213834832173977e-10,-1.4997739817030001e-10,-1.6947686414883153e-08,-1.8185961953992884e-09,-8.478186992305364e-10,9.985516652225627e-11,1.9425086965345766e-08];
safety.gamma_V_data = [287.04607595496805];
safety.gamma_B_data = [2416.7692979520334];

ctrl.grid.pll.enable = 0.01;
ctrl.grid.ictrl.enable = 0.02;
grid.breaker_close = 0.04;
machine.breaker_close = 0.04;
ctrl.machine.ictrl.ref_enable = 0.1;
load1.stepTime = 1;

%%

grid.w = 2*pi*grid.f;
grid.vn = grid.v / sqrt(3);
grid.in = converter.s / 3 / grid.vn;
grid.zn = grid.vn / grid.in;
grid.ln = grid.zn / grid.w;
grid.vpeak = grid.vn * sqrt(2);
grid.ipeak = grid.in * sqrt(2);
grid.tr.l_si = grid.tr.l * grid.ln;
grid.tr.r_si = grid.tr.r * grid.zn;

machine.w = 2*pi*machine.f;
machine.w_set = machine.w * machine.f_gain;
machine.vn = machine.v / sqrt(3);
machine.sn = converter.s / 3;
machine.in = machine.sn / machine.vn;
machine.zn = machine.vn / machine.in;
machine.ln = machine.zn / machine.w;
machine.cn = 1 / machine.zn / machine.w;
machine.vpeak = machine.vn * sqrt(2);
machine.ipeak = machine.in * sqrt(2);
machine.tr.l_si = machine.tr.l * machine.ln;
machine.tr.r_si = machine.tr.r * machine.zn;

% mmc.cell.c_n = converter.s / 3 / mmc.cell.v_dc^2;
mmc.cell.c_n = converter.s / 9 / mmc.cell.v_dc^2;
mmc.cell.c_dc_pu = mmc.cell.c_dc / mmc.cell.c_n;

mmc.l_leg_g = mmc.l_leg_si / grid.ln;
mmc.l_leg_m = mmc.l_leg_si / machine.ln;
mmc.r_leg_g = mmc.r_leg_si / grid.zn;
mmc.r_leg_m = mmc.r_leg_si / machine.zn;

meas.bp16.f1 = (1 - 0.025) * 50 / 3 / sim.fs_unit;
meas.bp16.f2 = (1 + 0.025) * 50 / 3 / sim.fs_unit;
meas.bp33.f1 = (1 - 0.025) * 100 / 3 / sim.fs_unit;
meas.bp33.f2 = (1 + 0.025) * 100 / 3 / sim.fs_unit;
meas.bp50.f1 = (1 - 0.025) * 50 / sim.fs_unit;
meas.bp50.f2 = (1 + 0.025) * 50 / sim.fs_unit;
meas.bp100.f0 = (1 - 0.05) * 100 / sim.fs_unit;
meas.bp100.f1 = (1 - 0.025) * 100 / sim.fs_unit;
meas.bp100.f2 = (1 + 0.025) * 100 / sim.fs_unit;
meas.bp100.f3 = (1 + 0.05) * 100 / sim.fs_unit;

ctrl.machine.pll.kp = ctrl.grid.pll.kp / 3;
ctrl.machine.pll.ti = ctrl.grid.pll.ti * 3;
ctrl.machine.pll.enable = ctrl.grid.pll.enable;
ctrl.machine.pll.init_w = machine.f_gain;
ctrl.machine.ictrl.kp = ctrl.grid.ictrl.kp / 3;
ctrl.machine.ictrl.ti = ctrl.grid.ictrl.ti * 3;
ctrl.machine.ictrl.enable = ctrl.grid.ictrl.enable;

ctrl.grid.pll.ki = ctrl.grid.pll.kp / ctrl.grid.pll.ti;
ctrl.grid.ictrl.ki = ctrl.grid.ictrl.kp / ctrl.grid.ictrl.ti;

ctrl.machine.pll.ki = ctrl.machine.pll.kp / ctrl.machine.pll.ti;
ctrl.machine.ictrl.ki = ctrl.machine.ictrl.kp / ctrl.machine.ictrl.ti;

ctrl.vdcctrl.ki = ctrl.vdcctrl.kp / ctrl.vdcctrl.ti;

pq_ctrl.ki = pq_ctrl.kp / pq_ctrl.ti;

ratio = 1.0;
load1.r_si = machine.tr.r_si * ratio;
load1.l_si = machine.tr.l_si * ratio;

% % total impedance
% grid.l = grid.tr.l + 3 * mmc.l_leg / machine.ln;

%%

sqrt3 = sqrt(3);

abc_to_ab0 = [
    2 -1 -1;
    0 sqrt(3) -sqrt(3);
    1 1 1
]/3;

ab0_to_abc = inv(abc_to_ab0);

% two stage ab0 transformation
cell_to_2ab0 = kron(abc_to_ab0, abc_to_ab0);
ab0_to_cell = inv(cell_to_2ab0);

grid_to_cell = kron(eye(3), ones(3, 1));
machine_to_cell = kron(ones(3, 1), eye(3));

l1 = 0.5*mmc.l_leg_g/grid.tr.l;
l2 = 0.5*mmc.l_leg_m/machine.tr.l;

volt_to_cell = [ ...
    [ ...
        1 0 0 0 0 0;
        0 1 0 0 0 0;
        0 0 0 -1 0 0; 
        0 0 0 0 -1 0;
        0 0 1 0 0 -1;
    ], [ ...
        l1+1 0 0 0;
        0 l1+1 0 0;
        0 0 -l2-1 0;
        0 0 0 -l2-1;
        0 0 0 0;
    ], [ ...
        grid.tr.r 0 0 0 0 0;
        0 grid.tr.r 0 0 0 0;
        0 0 0 -machine.tr.r 0 0;
        0 0 0 0 -machine.tr.r 0;
        0 0 grid.tr.r 0 0 -machine.tr.r;
    ], -mmc.r_leg_m * eye(5)
];
